import{f as e,ah as a,bw as s,v as t,ak as i,bP as l,Q as r,R as o,bQ as n,y as c,m as u,I as d,a0 as p,cL as m,al as f,bt as v,cv as b,g as h,bN as _,r as g,P as x,n as k,gH as y,U as w,am as N,i as j,c as S,o as T,a as A,b as $,K as F,B as C,w as E,d as I,t as R,aE as P,s as U,F as W,D as z,e as L,a6 as V,a5 as B,C as O,$ as H,G as M,ag as D,H as Q,J as G,aO as q,cn as J,ad as K,bZ as X,bS as Y,bT as Z,bU as ee,bW as ae,bX as se,bY as te}from"#entry";import{_ as ie}from"./Ctabeo0j.js";import{E as le}from"./1bXUUYzG.js";import{_ as re}from"./BbcemesW.js";import{r as oe,u as ne}from"./BUyr3k23.js";import{b as ce}from"./DJQ0f6YX.js";import{u as ue}from"./D1RQ0Ig2.js";import"./DWsaYBFQ.js";import"./EyvYgUJ0.js";import"./DZrW0QoB.js";import"./CZIhrSUn.js";import"./DhoqPgLY.js";import"./DYraDxUd.js";import"./DMZvEsQv.js";import"./Div4Sb7D.js";import"./htzw4K3n.js";import"./Dj5W2tf4.js";import"./4ZxzSbBH.js";import"./Ci0kdpII.js";import"./md0wCl8Q.js";import"./BuTxD5e6.js";import"./vIWCTboT.js";import"./C7V9UFRI.js";import"./NZiWsxCB.js";import"./CXu7cHRZ.js";import"./U3Xc_iuw.js";import"./DC37kyC8.js";import"./DkMFijTu.js";const de={class:"flex justify-between items-center mt-10px pr-15px"},pe=["infinite-scroll-disabled"],me={class:"pr-10px pb-20px"},fe={class:"flex-[1.5] flex items-center"},ve={class:"ml-6px"},be={class:"flex"},he={class:"color-[var(--main-text)]"},_e={class:"mt-2px color-[--third-text]"},ge={class:"flex-1 flex flex-col items-end"},xe={class:"flex-1 flex justify-end"},ke={key:1,class:"color-[var(--d-EAECEF-l-333)]"},ye={key:0,class:"color-#959a9f text-12px text-center"},we=e({__name:"positionsTable",props:{height:{type:[Number,String],default:370}},setup(e){const{updateHolderNum:we}=a(s()),{t:Ne}=t(),je=i(),Se=l(),Te=r(),Ae=ce(),$e=ue(),Fe=o(),Ce=n(),{hide_risk:Ee,hide_small:Ie}=a(c());function Re(){Ge.value.pageNo=1,Ge.value.finished=!1}u(()=>je.wsResult[f.PRICEV2],e=>{const a={};e.prices.forEach(e=>{a[e.token+"-"+e.chain]=e}),qe.value=qe.value.map(e=>{const s=a[e.index];if(s&&s.uprice>0){const a="--"===e.total_profit||0===Number(e.total_profit),t=new p(e.balance||0).times(s.uprice||0);if(a)return{...e,current_price_usd:s.uprice,balance_usd:t.toNumber()};{const a=new p(e.balance_usd||0).minus(e.total_profit||0),i=t.minus(a),l=new p(s.uprice||0).minus(e.average_purchase_price_usd||0).div(e.average_purchase_price_usd);return l.toNumber()<-1||Number(e.average_purchase_price_usd)<0?e:{...e,current_price_usd:s.uprice,balance_usd:t.toNumber(),total_profit:i.toFixed(),total_profit_ratio:l.toFixed()}}}return e}),m(qe)}),u(()=>we.value,()=>{Re(),Oe()}),u(()=>je.wsResult[f.ASSET],e=>{if(e.swap){const a="So11111111111111111111111111111111111111112"===e.swap.token||e.swap.token===b?b:e.swap.token,s=e.swap.chain;a&&s&&setTimeout(()=>{Re(),Oe()},5e3)}else if(e.transfer){const a=e.transfer.chain,s=e.transfer.token,t=e.transfer.type;if(s&&a){const i=qe.value.findIndex(e=>e.token===s&&e.chain===a),l="0"===t;if(i>-1){const a=qe.value[i],s=Number(a.balance),t=a.current_price_usd,r=new p(s).plus(l?e.transfer.amount:-e.transfer?.amount),o=r.multipliedBy(t);a.balance=r.toString(),a.balance_usd=o.toNumber(),m(qe)}else setTimeout(()=>{Re(),Oe()},5e3)}}});const Pe=h(()=>"evm"===_(Fe.chain)?.vm_type),Ue=h(()=>Te.userInfo?Te.userInfo.addresses.map(({address:e,chain:a})=>e+"-"+a):Fe.address&&Pe.value&&"WatchWallet"!==Fe.walletName?[Fe.address+"-bsc",Fe.address+"-base",Fe.address+"-eth"]:[Fe.address+"-"+Fe.chain]);u(()=>Ue.value,()=>{We.value.user_ids=Ue.value});const We=g({hide_risk:Ee,hide_small:Ie,user_ids:Ue.value}),ze=g({}),Le=e,Ve=h(()=>Number(Le.height)-110),Be=x("scrollContainerRef"),Oe=v(()=>{const{value:e}=Be;e&&e.scrollHeight<=e.clientHeight&&!Ge.value.finished&&Je()},200);u(Ve,Oe);const He=d({sortBy:void 0,activeSort:0}),Me={"-1":"asc",1:"desc"},De=h(()=>({sort_dir:Me[He.value.activeSort],sort:He.value.sortBy})),Qe=h(()=>[{label:`${Ne("token")}/${Ne("balance1")}`,value:"balance_usd",flex:"flex-[1.5]",sort:!0},{label:Ne("profit2"),value:"total_profit",flex:"flex-1 justify-end",sort:!0},{label:"",value:"",flex:"flex-1 justify-end",sort:!1}]),Ge=d({finished:!1,loading:!1,pageNo:1,pageSize:10}),qe=d([]);async function Je(){try{Ge.value.loading=!0;const e=Ge.value.pageNo,a=await y({pageNO:Ge.value.pageNo,pageSize:Ge.value.pageSize,...We.value,...De.value});if(Array.isArray(a?.data)&&a.data.length>0){if(1===e)qe.value=a.data.map(e=>({...e,index:e.token===b?_(e.chain)?.wmain_wrapper+"-"+e.chain:`${e.token}-${e.chain}`}));else{const e=a.data.filter(e=>qe.value.every(a=>a.index!==`${e.token}-${e.chain}`)).map(e=>({...e,index:e.token===b?_(e.chain)?.wmain_wrapper+"-"+e.chain:`${e.token}-${e.chain}`}));qe.value=qe.value.concat(e)}Ge.value.finished=a.data.length<Ge.value.pageSize,Ge.value.finished||Ge.value.pageNo++}else 1===Ge.value.pageNo&&(qe.value=[]);$e.setMultiPriceParams("positions",qe.value.map(e=>e.token+"-"+e.chain)),$e.sendPriceWs()}catch(e){}finally{Ge.value.loading=!1,m(Ge)}}async function Ke(e){if(!K())return;if(!e.token)return;const a=Te.getWalletAddress(e.chain);if(a)try{ze.value[e.index]=!0;const s=(await X({chain:e.chain,tokens:[e.token],walletAddress:a}))[0];s&&(e.balance=s.balance||0,e.balance_usd=new p(s.balance||0).times(e.current_price_usd||0).toNumber(),e.decimals=s.decimals||e.decimals);const t=s.balance||0;if(!t)return void Y({title:"Error",type:"error",message:s("insufficientBalance")});await Ae.checkApproveAndApprove({chain:e.chain,token:e.token,owner:a}),function(e,a){if(!K())return;if(new p(e||0).lte(0))return void Y({title:"Error",type:"error",message:Ne("amountMustG0")});const s=new p(e||0).toFixed().match(new RegExp(`[0-9]*(\\.[0-9]{0,${a.decimals||18}})?`))?.[0];if((Number(s)||0)<=0)return void Y({title:"Error",type:"error",message:Ne("amountTooSmall")});ze.value[a.index]=!0,async function(e,a){const s="solana"===a.chain,{botSettings:t}=Se,i=t?.[a.chain]?.sell?.selected,l=t?.[a.chain]?.sell?.[i];if(s&&l?.mev&&!(await Te.getBundleAvailable()))return void(ze.value[a.index]=!1);const{gasTip1List:r,gasTip2List:o}=Z(ee().gasTip,"solana"),n=l?.mev?r:o,c=l?.mev?l?.gas[0]:l?.gas?.[1];let d={};if(s){let e=c?.customFee||n?.[c?.level]||"0.002";l?.mev&&new p(e).lt("0.002")&&(e="0.002"),d.priorityFee=new p(e).times(10**9).toFixed(0)}else{const e=0===Number(c?.customFee)?"0":c?.customFee||n?.[c?.level]||"3";d.gasTip=Number(new p(e).times(10**9).toFixed(0)),d.contractType=0,d.chain=a.chain}const m={solana:"sol",ton:"TON"}[a.chain]||b,f=l?.slippage||"9",v=Te.getWalletAddress(a.chain);if(!v)return;d={...d,batchId:Date.now().toString(),swapList:[{creatorAddress:v,inAmount:new p(e||0).times(10**a.decimals||0).toFixed(0)}],inTokenAddress:a.token,outTokenAddress:m,swapType:2,isPrivate:l?.mev||!1,slippage:"auto"!==f?Number(new p(f).times(100).toFixed(0)):900};(s?ae(d):se(d)).then(e=>function(e,a,s,t){if(e){let i=setTimeout(()=>{Y({type:"success",message:Ne("transactionsSubmitted")}),Ce.placeOrderUpdate++,ze.value[s]=!1},500);const l=t?.chain||"",r=e?.[0]||{};oe({txInfo:r,chain:l,destination:"solana"===l?"/botapi/swap/createSolTx":"/botapi/swap/createSwapEvmTx",type:10});const o={[r?.batchId]:r?.id},n=u(()=>je.wsResult.tgbot,e=>{const t=e.batchId;if(t===a){if(i&&(clearTimeout(i),i=null),Ce.placeOrderSuccess++,e?.txList?.[0]?.success){Y({type:"success",message:Ne("tradeSuccess")});const a=e?.txList?.[0];ne({...a,chain:e?.chain},o?.[t]||"")}else te(e?.txList?.[0]?.failMessage||"swap error");n(),ze.value[s]=!1}})}}(e,d.batchId,a.index,a)).catch(e=>{te(e||"swap error"),ze.value[a.index]=!1})}(e,a)}(t,e)}finally{ze.value[e.index]=!1}}return k(()=>{Je()}),u(()=>[De.value,We.value.hide_risk,We.value.hide_small,Te.evmAddress,()=>Fe.address,()=>Fe.walletSignature[Fe.address]],()=>{Re(),Je()}),(e,a)=>{const s=P,t=ie,i=B,l=V,r=O,o=Q,n=L,c=q,u=le,d=J,p=N;return w((T(),S("div",null,[A("div",de,[$(s,{modelValue:j(We).hide_risk,"onUpdate:modelValue":a[0]||(a[0]=e=>j(We).hide_risk=e),class:"ml-12px",style:{marginRight:0},size:"small","true-value":1,"false-value":0},{default:E(()=>[I(R(e.$t("hideRiskTokenShort")),1)]),_:1},8,["modelValue"]),$(s,{modelValue:j(We).hide_small,"onUpdate:modelValue":a[1]||(a[1]=e=>j(We).hide_small=e),size:"small","true-value":1,"false-value":0},{default:E(()=>[I(R(e.$t("hideSmallAssets1")+"<1USD"),1)]),_:1},8,["modelValue"]),j(Te).evmAddress||j(Fe).address&&j(Pe)&&"WatchWallet"!==j(Fe).walletName?(T(),F(t,{key:0,userIds:j(We).user_ids,"onUpdate:userIds":[a[2]||(a[2]=e=>j(We).user_ids=e),a[3]||(a[3]=e=>{Re(),Je()})]},null,8,["userIds"])):C("",!0)]),$(re,{sort:j(He),"onUpdate:sort":a[4]||(a[4]=e=>U(He)?He.value=e:null),columns:j(Qe)},null,8,["sort","columns"]),$(u,{height:j(Ve)},{default:E(()=>[w((T(),S("div",{ref_key:"scrollContainerRef",ref:Be,"infinite-scroll-disabled":j(Ge).finished||j(Ge).loading,"infinite-scroll-distance":"200","infinite-scroll-delay":10,"infinite-scroll-immediate":!1},[A("div",me,[(T(!0),S(W,null,z(j(qe),(a,s)=>(T(),F(n,{key:s,class:"text-12px flex justify-between pl-10px py-10px cursor-pointer hover:bg-[--dialog-bg]",to:`/token/${a.index}`},{default:E(()=>[A("div",fe,[$(l,{"popper-class":"tooltip-pd-0",placement:"bottom-start","show-arrow":!1},{default:E(()=>[$(i,{row:a},null,8,["row"])]),content:E(()=>[$(i,{row:a,"chain-class":"hidden","token-class":"w-240px h-240px [&&]:mr-0 rounded-16px"},null,8,["row"])]),_:2},1024),A("div",ve,[A("div",be,[A("span",he,R(a.symbol),1),a.risk_score>55||a.risk_level<0?(T(),F(r,{key:0,name:"custom:danger",class:"font-14 ml-2px color-#F72121"})):C("",!0)]),A("div",_e,[0===a.balance?(T(),S(W,{key:0},[I("$0")],64)):"--"===a.balance?(T(),S(W,{key:1},[I("--")],64)):(T(),S(W,{key:2},[I(R(("formatNumber"in e?e.formatNumber:j(H))(a.balance,2))+"("+R("$"+("formatNumber"in e?e.formatNumber:j(H))(a.balance_usd||0,2))+") ",1)],64))])])]),A("div",ge,[A("div",{class:M(("getColorClass"in e?e.getColorClass:j(D))(a.total_profit))},[0===Number(a.total_profit)?(T(),S(W,{key:0},[I("0")],64)):"--"===a.total_profit?(T(),S(W,{key:1},[I("--")],64)):(T(),S(W,{key:2},[I(R(Number(a.total_profit)>0?"$":"-$")+R(("formatNumber"in e?e.formatNumber:j(H))(Math.abs(Number(a.total_profit)),2)),1)],64))],2),A("div",{class:M(("getColorClass"in e?e.getColorClass:j(D))(a.total_profit_ratio))},[0===Number(a.total_profit_ratio)?(T(),S(W,{key:0},[I("0")],64)):"--"===a.total_profit_ratio?(T(),S(W,{key:1},[I("--")],64)):(T(),S(W,{key:2},[I(R(Number(a.total_profit_ratio)>0?"+":"-")+R(("formatNumber"in e?e.formatNumber:j(H))(Math.abs(100*Number(a.total_profit_ratio)),2))+"% ",1)],64))],2)]),A("div",xe,[j(Te).evmAddress&&"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"!==a.token?(T(),F(o,{key:0,size:"small",loading:j(ze)[a.index],class:"[--el-border:0] [&&]:[--el-button-bg-color:--d-222-l-F2F2F2] [&&]:font-normal",style:{padding:"4px"},onClick:G(e=>Ke(a),["stop","prevent"])},{default:E(()=>[I(R(e.$t("closePosition")),1)]),_:1},8,["loading","onClick"])):(T(),S("span",ke,"--"))])]),_:2},1032,["to"]))),128)),0!==j(qe).length||j(Ge).loading?C("",!0):(T(),F(c,{key:0}))]),j(Ge).loading&&1!==j(Ge).pageNo?(T(),S("div",ye,R(e.$t("loading")),1)):C("",!0)],8,pe)),[[d,Je]])]),_:1},8,["height"])])),[[p,j(Ge).loading&&1===j(Ge).pageNo]])}}});export{we as default};
